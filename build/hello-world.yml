jobs:
- job: Hello_World
  pool:
    vmImage: windows-latest
  steps:
  - pwsh: |
      Write-Host "Hello world"

      $targetBranch = $env:SYSTEM_PULLREQUEST_TARGETBRANCH
      if (-not $targetBranch) {
        Write-Host "Sorry, this pipeline can only be run from PRs."
      }
      else {
        #Write-Host "sourceBranch = $env:SYSTEM_PULLREQUEST_SOURCEBRANCH"            # cibuild-tryout
        #Write-Host "targetBranch = $env:SYSTEM_PULLREQUEST_TARGETBRANCH"            # main
        #Write-Host "sourceCommitId = $env:SYSTEM_PULLREQUEST_SOURCECOMMITID"        # tip of PR

        $mergeCommitHash = git rev-parse "HEAD"
        Write-Host "mergeCommitHash = $mergeCommitHash"
        $targetCommitHash = git rev-parse "origin/$targetBranch"
        Write-Host "targetCommitHash = $targetCommitHash"

        dotnet tool restore

        if ($LastExitCode -ne 0) {
          throw "Command 'dotnet tool restore' failed with exit code $LastExitCode."
        }

        dotnet restore src

        if ($LastExitCode -ne 0) {
          throw "Command 'dotnet restore src' failed with exit code $LastExitCode."
        }

        # bug workaround
        cd src

        dotnet regitlint -s Steeltoe.All.sln --print-command --skip-tool-check --disable-jb-path-hack --jb --profile='\"Steeltoe Full Cleanup\"' --jb --properties:Configuration=Release --jb --verbosity=WARN -f commits -a $mergeCommitHash -b $targetCommitHash --print-diff

        if ($LastExitCode -ne 0) {
          throw "Command 'dotnet regitlint' failed with exit code $LastExitCode."
        }

        cd ..

        git add -A .
        git diff-index --quiet HEAD --
        $hasChangesToCommit = $LastExitCode -ne 0
        Write-Host "hasChangesToCommit = $hasChangesToCommit"

        if ($hasChangesToCommit) {
          git commit -m "Automated code Cleanup"
          git push

          if ($LastExitCode -ne 0) {
            throw "Command 'git push' failed with exit code $LastExitCode."
          }
        }
      }
    displayName: Write message

trigger: none

jobs:
- job: PR_Code_Cleanup
  variables:
    DOTNET_NOLOGO: true
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
    DOTNET_CLI_TELEMETRY_OPTOUT: 1
  pool:
    vmImage: windows-latest
  steps:
  - task: PowerShell@2
    displayName: Validate preconditions
    inputs:
      targetType: 'inline'
      script: |
        if (-not $env:SYSTEM_PULLREQUEST_TARGETBRANCH) {
          throw "This pipeline can only be run from pull requests. Use "/azp cleanup" in a GitHub PR comment."
        }
  - checkout: self
    persistCredentials: true
  - task: PowerShell@2
    displayName: Checkout PR branch
    inputs:
      targetType: 'inline'
      script: |
        # We're going to push changes, so we need to be on the PR branch
        # instead of the detached head that contains the merge result.
        Write-Host "Switching to branch $env:SYSTEM_PULLREQUEST_SOURCEBRANCH"
        git checkout $env:SYSTEM_PULLREQUEST_SOURCEBRANCH
  - task: PowerShell@2
    displayName: Restore tools and packages
    inputs:
      targetType: 'inline'
      script: |
        dotnet tool restore
        dotnet restore src2
  - task: PowerShell@2
    displayName: Code cleanup
    inputs:
      targetType: 'inline'
      script: |
        # Find the most-recent common ancestor to diff against. Using the target branch name is incorrect because this PR may be outdated.
        $baseCommitHash = git merge-base origin/$env:SYSTEM_PULLREQUEST_SOURCEBRANCH origin/$env:SYSTEM_PULLREQUEST_TARGETBRANCH

        $headCommitHash = git rev-parse "HEAD"
        Write-Host "Using commit range for cleanup: $baseCommitHash..$headCommitHash"
        dotnet regitlint -s Steeltoe.All.sln --print-command --skip-tool-check --disable-jb-path-hack --jb-profile="Steeltoe Full Cleanup" --jb --properties:Configuration=Release --jb --verbosity=WARN -f commits -a $headCommitHash -b $baseCommitHash
  - task: PowerShell@2
    displayName: Push changes
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)  
    inputs:
      targetType: 'inline'
      script: |
        git add -A
        git diff-index --quiet HEAD --
        $hasChangesToCommit = $LastExitCode -ne 0

        if ($hasChangesToCommit) {
          Write-Host "Code cleanup resulted in changes."
          git config --global user.email "cibuild@steeltoe.com"
          git config --global user.name "steeltoe-cibuild"

          Write-Host "Committing changes."
          git commit -m "Automated code cleanup from cibuild"

          #Write-Host "Pushing changes."
          #git push origin
        }
        else {
          Write-Host "Code cleanup did not change any files."
        }

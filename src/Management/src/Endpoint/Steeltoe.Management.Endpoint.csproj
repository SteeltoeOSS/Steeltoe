<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFrameworks>net10.0;net8.0</TargetFrameworks>
    <Description>Steeltoe management endpoints, also known as actuators. Includes support for Cloud Foundry integration.</Description>
    <PackageTags>actuator;actuators;management;monitoring;Spring;Boot;dbmigrations;health;heap-dump;loggers;route-mappings;thread-dump;tanzu</PackageTags>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <IsPackable>true</IsPackable>
  </PropertyGroup>

  <Import Project="..\..\..\..\shared.props" />

  <ItemGroup>
    <PackageReference Include="dotnet-gcdump" Version="$(DotnetGCDumpVersion)" IncludeAssets="None" ExcludeAssets="All" PrivateAssets="None"
      GeneratePathProperty="true">
      <!--
          The dotnet-gcdump global tool can't be referenced, but we can download it.
          GeneratePathProperty makes the path to the package available in $(Pkgdotnet-gcdump), so we can add an assembly reference.
          See https://docs.microsoft.com/en-us/nuget/consume-packages/package-references-in-project-files#generatepathproperty.
          Based on: https://blog.maartenballiauw.be/post/2020/04/22/referencing-specific-assembly-nuget-package.html.
		    -->
    </PackageReference>
    <PackageReference Include="Microsoft.Diagnostics.NETCore.Client" Version="$(MicrosoftDiagnosticsNETCoreClientVersion)" />
    <PackageReference Include="Microsoft.Diagnostics.Tracing.TraceEvent" Version="$(MicrosoftDiagnosticsTracingTraceEventVersion)" />
    <PackageReference Include="System.IdentityModel.Tokens.Jwt" Version="$(SystemIdentityModelVersion)" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\..\Common\src\Hosting\Steeltoe.Common.Hosting.csproj" />
    <ProjectReference Include="..\..\..\Common\src\Http\Steeltoe.Common.Http.csproj" />
    <ProjectReference Include="..\..\..\Configuration\src\Abstractions\Steeltoe.Configuration.Abstractions.csproj" />
    <ProjectReference Include="..\..\..\Logging\src\DynamicConsole\Steeltoe.Logging.DynamicConsole.csproj" />
    <ProjectReference Include="..\Abstractions\Steeltoe.Management.Abstractions.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Reference Include="dotnet-gcdump">
      <!--
        Caution: The embedded version of Microsoft.Diagnostics.FastSerialization must be binary compatible with the one
        embedded in Microsoft.Diagnostics.Tracing.TraceEvent, otherwise a TypeLoadException will occur at runtime.
      -->
      <HintPath>$(Pkgdotnet-gcdump)\tools\net8.0\any\dotnet-gcdump.dll</HintPath>
    </Reference>
  </ItemGroup>

  <!-- Embed dotnet-gcdump.dll in our multi-targeted NuGet package. -->
  <Target Name="IncludeDotNetGCDumpAssemblyInPack" BeforeTargets="_GetPackageFiles">
    <ItemGroup>
      <_DotNetGCDumpNet10 Include="$(MSBuildProjectDirectory)\bin\$(Configuration)\net10.0\dotnet-gcdump.dll" Pack="True" PackagePath="lib\net10.0" />
      <_DotNetGCDumpNet8 Include="$(MSBuildProjectDirectory)\bin\$(Configuration)\net8.0\dotnet-gcdump.dll" Pack="True" PackagePath="lib\net8.0" />
      <None Include="@(_DotNetGCDumpNet10)" />
      <None Include="@(_DotNetGCDumpNet8)" />
    </ItemGroup>
  </Target>
</Project>
